CKEDITOR.dialog.add("pbckcodeDialog",function(editor){"use strict";if(editor.config.pbckcode===undefined){editor.config.pbckcode={}}var DEFAULT_SETTINGS={cls:"",modes:[["HTML","html"],["CSS","css"],["PHP","php"],["JS","javascript"]],theme:"textmate"};var settings=merge_settings(DEFAULT_SETTINGS,editor.config.pbckcode);var AceEditor,shighlighter=new PBSyntaxHighlighter(settings.highlighter);return{title:editor.lang.pbckcode.title,minWidth:600,minHeight:400,contents:[{id:"code-container",label:editor.lang.pbckcode.title,elements:[{type:"select",id:"code-select",items:settings.modes,"default":settings.modes[0][1],setup:function(element){if(element){element=element.getAscendant("pre",true);this.setValue(element.getAttribute("data-pbcklang"))}},commit:function(element){if(element){element=element.getAscendant("pre",true);element.setAttribute("data-pbcklang",this.getValue())}},onChange:function(element){AceEditor.getSession().setMode("ace/mode/"+this.getValue())}},{type:"html",html:'<div id="code_'+editor.codeId+'"></div>',id:"code-textarea",style:"position: absolute; top: 80px; left: 10px; right: 10px; bottom: 50px;",setup:function(element){var code=element.getHtml();code=code.replace(new RegExp("<br/>","g"),"\n");code=code.replace(new RegExp("<br>","g"),"\n");code=code.replace(new RegExp("&lt;","g"),"<");code=code.replace(new RegExp("&gt;","g"),">");code=code.replace(new RegExp("&amp;","g"),"&");AceEditor.setValue(code)},commit:function(element){element.setText(AceEditor.getValue())}}]}],onLoad:function(){AceEditor=ace.edit("code_"+editor.codeId);AceEditor.getSession().setMode("ace/mode/"+settings.modes[0][1]);AceEditor.setTheme("ace/theme/"+settings.theme);editor.aceEditor=AceEditor},onShow:function(){var selection=editor.getSelection();var element=selection.getStartElement();if(element){element=element.getAscendant("pre",true)}if(!element||element.getName()!=="pre"){element=new CKEDITOR.dom.element("pre");if(shighlighter.getTag()!=="pre"){element.append(new CKEDITOR.dom.element("code"))}this.insertMode=true}else{if(shighlighter.getTag()!=="pre"){element=element.getChild(0)}this.insertMode=false}this.element=element;AceEditor.setValue("");if(!this.insertMode){this.setupContent(this.element)}},onOk:function(){var pre,element;pre=element=this.element;if(this.insertMode){if(shighlighter.getTag()!=="pre"){element=this.element.getChild(0)}}else{pre=element.getAscendant("pre",true)}this.commitContent(element);shighlighter.setCls(pre.getAttribute("data-pbcklang")+" "+settings.cls);element.setAttribute("class",shighlighter.getCls());if(this.insertMode){editor.insertElement(pre)}}}});CKEDITOR.dialog.on("resize",function(evt){var AceEditor=evt.editor.aceEditor;if(AceEditor!==undefined){AceEditor.resize()}});function merge_settings(dft,usr){"use strict";var obj3={};for(var attrname in dft){obj3[attrname]=dft[attrname]}for(var attrname in usr){obj3[attrname]=usr[attrname]}return obj3}